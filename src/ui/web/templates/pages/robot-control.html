<!-- PRIORITY EMBEDDED ROBOT CONTROL SCRIPT - MUST LOAD FIRST -->
<script>
console.log('üöÄ [EMBEDDED] PRIORITY LOAD - Robot Control Direct Implementation Starting...');

// IMMEDIATELY disable any existing robot control functionality
window.EMBEDDED_ROBOT_CONTROL_ACTIVE = true;
window.EMBEDDED_ROBOT_INITIALIZED = false;

// Block existing functions immediately on load
const embeddedBlockFunctions = [
    'handleConnect', 'handleDisconnect', 'handleServoOn', 'handleServoOff',
    'handleHomeAxis', 'handleMoveAbsolute', 'handleMoveRelative', 'handleEmergencyStop',
    'handleRefreshStatus'
];

embeddedBlockFunctions.forEach(funcName => {
    Object.defineProperty(window, funcName, {
        value: function() { 
            console.log(`üö´ [EMBEDDED] BLOCKED existing ${funcName} - Using embedded version`); 
            return false;
        },
        writable: false,
        configurable: false
    });
});

console.log('‚úÖ [EMBEDDED] Priority blocking completed - Existing functions disabled');
</script>

<!--
Robot Hardware Control Panel Template - WF EOL Tester Web Interface

This template provides comprehensive robot control functionality including:
- Connection management (Connect/Disconnect)
- Servo control (Enable/Disable motor power)  
- Movement controls (Home Axis, Move Absolute, Move Relative)
- Position display and monitoring
- Motion parameters configuration (velocity, acceleration, deceleration)
- Emergency stop functionality
- Status monitoring (connection, position, servo state, motion status)
-->

<div id="robot-control" class="content-page hardware-control-panel" style="display: none;">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                Robot Control System
            </h1>
            <div class="page-subtitle">
                AJINEXTEK Motion Controller
            </div>
        </div>
        
        <!-- Status Badge -->
        <div class="status-badge" id="robot-status-badge">
            <div class="status-indicator">
                <div class="status-light status-unknown"></div>
                <span class="status-text">Disconnected</span>
            </div>
        </div>
    </div>

    <!-- Compact 2-Column Layout for 1280x1024 -->
    <div class="compact-layout-1280">
        <!-- Left Column: Controls and Status -->
        <div class="left-column">
            <!-- Connection Panel - Compact -->
            <div class="control-panel connection-panel compact">
                <div class="panel-header compact">
                    <h3>Connection</h3>
                    <div class="connection-status" id="robot-connection-status">
                        <div class="status-dot status-unknown"></div>
                        <span>Disconnected</span>
                    </div>
                </div>
                
                <div class="panel-content compact">
                    <div class="connection-info-compact" id="robot-connection-info">
                        <div class="info-row-inline">
                            <label for="robot-axis-select">Axis:</label>
                            <select id="robot-axis-select" class="form-control form-control-sm compact">
                                <option value="0">Axis 0</option>
                                <option value="1">Axis 1</option>
                                <option value="2">Axis 2</option>
                                <option value="3">Axis 3</option>
                            </select>
                            <span class="connection-type">AJINEXTEK (IRQ: <span id="robot-irq-no">7</span>)</span>
                        </div>
                    </div>
                    
                    <div class="connection-controls compact">
                        <button class="btn btn-success btn-sm" id="robot-connect-btn">
                            <i class="icon-connect"></i>
                            Connect
                        </button>
                        <button class="btn btn-secondary btn-sm" id="robot-disconnect-btn" disabled>
                            <i class="icon-disconnect"></i>
                            Disconnect
                        </button>
                        <button class="btn btn-outline btn-sm" id="robot-refresh-status-btn">
                            <i class="icon-refresh"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Position and Status Panel - Compact 2x2 Grid -->
            <div class="control-panel status-panel compact">
                <div class="panel-header compact">
                    <h3>Position & Status</h3>
                    <button class="btn btn-xs btn-primary" id="robot-get-position-btn">
                        <i class="icon-target"></i>
                        Read
                    </button>
                </div>
                
                <div class="panel-content compact">
                    <div class="status-grid-compact">
                        <div class="status-card compact">
                            <div class="status-label">üìç Position</div>
                            <div class="status-value large" id="robot-current-position">
                                <span class="value">---.---</span>
                                <span class="unit">Œºm</span>
                            </div>
                        </div>
                        
                        <div class="status-card compact">
                            <div class="status-label">‚öôÔ∏è Servo Status</div>
                            <div class="status-value" id="robot-servo-status">
                                <span class="status-indicator">
                                    <div class="status-dot status-unknown"></div>
                                    <span>Unknown</span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="status-card compact">
                            <div class="status-label">üîÑ Motion Status</div>
                            <div class="status-value" id="robot-motion-status">
                                <span class="status-indicator">
                                    <div class="status-dot status-unknown"></div>
                                    <span>Unknown</span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="status-card compact">
                            <div class="status-label">üéØ Initialization</div>
                            <div class="status-value" id="robot-init-status">
                                <span class="status-indicator">
                                    <div class="status-dot status-unknown"></div>
                                    <span>Not Init</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Servo & Emergency Control Panel - Combined -->
            <div class="control-panel servo-emergency-panel compact">
                <div class="panel-header compact">
                    <h3>Motor & Safety Control</h3>
                    <div class="warning-indicator compact">
                        <i class="icon-warning"></i>
                        Critical Controls
                    </div>
                </div>
                
                <div class="panel-content compact">
                    <div class="control-grid-2x2">
                        <button class="btn btn-success btn-sm" id="robot-servo-on-btn" disabled>
                            <i class="icon-power-on"></i>
                            Enable Servo
                        </button>
                        
                        <button class="btn btn-warning btn-sm" id="robot-servo-off-btn" disabled>
                            <i class="icon-power-off"></i>
                            Disable Servo
                        </button>
                        
                        <button class="btn btn-danger emergency-btn-compact" id="robot-emergency-stop-btn">
                            <i class="icon-stop"></i>
                            EMERGENCY STOP
                        </button>
                        
                        <button class="btn btn-outline btn-sm" id="robot-stop-motion-btn" disabled>
                            <i class="icon-pause"></i>
                            Stop Motion
                        </button>
                    </div>
                    
                    <div class="safety-notice compact">
                        <i class="icon-info"></i>
                        <span>Ensure safety before operating</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Movement and Logs -->
        <div class="right-column">

            <!-- Movement Control Panel - Compact -->
            <div class="control-panel movement-panel compact">
                <div class="panel-header compact">
                    <h3>Movement Control</h3>
                    <div class="panel-tabs compact">
                        <button class="tab-btn active compact" data-tab="home">Home</button>
                        <button class="tab-btn compact" data-tab="absolute">Absolute</button>
                        <button class="tab-btn compact" data-tab="relative">Relative</button>
                    </div>
                </div>
                
                <div class="panel-content compact">
                    <!-- Home Tab -->
                    <div class="tab-content active" id="home-tab">
                        <div class="home-control compact">
                            <button class="btn btn-primary" id="robot-home-axis-btn" disabled>
                                <i class="icon-home"></i>
                                Home Axis to Origin (0.000 Œºm)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Absolute Move Tab -->
                    <div class="tab-content" id="absolute-tab">
                        <div class="move-form compact">
                            <div class="form-group compact">
                                <label for="absolute-position">Target Position (Œºm)</label>
                                <input type="number" id="absolute-position" class="form-control form-control-sm" 
                                       min="0" max="500000" step="0.001" placeholder="0.000">
                            </div>
                            
                            <div class="motion-parameters-compact">
                                <div class="form-row-compact">
                                    <div class="form-group-inline">
                                        <label>Vel:</label>
                                        <input type="number" id="absolute-velocity" class="form-control form-control-xs" 
                                               min="1" max="60000" step="0.1" value="200">
                                        <span class="unit">Œºm/s</span>
                                    </div>
                                    <div class="form-group-inline">
                                        <label>Acc:</label>
                                        <input type="number" id="absolute-acceleration" class="form-control form-control-xs" 
                                               min="100" max="60000" step="1" value="1000">
                                        <span class="unit">Œºm/s¬≤</span>
                                    </div>
                                    <div class="form-group-inline">
                                        <label>Dec:</label>
                                        <input type="number" id="absolute-deceleration" class="form-control form-control-xs" 
                                               min="100" max="60000" step="1" value="1000">
                                        <span class="unit">Œºm/s¬≤</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" id="robot-move-absolute-btn" disabled>
                                <i class="icon-target"></i>
                                Move to Position
                            </button>
                        </div>
                    </div>
                    
                    <!-- Relative Move Tab -->
                    <div class="tab-content" id="relative-tab">
                        <div class="move-form compact">
                            <div class="form-group compact">
                                <label for="relative-distance">Relative Distance (Œºm)</label>
                                <input type="number" id="relative-distance" class="form-control form-control-sm" 
                                       min="0" max="500000" step="0.001" placeholder="0.000">
                            </div>
                            
                            <div class="motion-parameters-compact">
                                <div class="form-row-compact">
                                    <div class="form-group-inline">
                                        <label>Vel:</label>
                                        <input type="number" id="relative-velocity" class="form-control form-control-xs" 
                                               min="1" max="60000" step="0.1" value="200">
                                        <span class="unit">Œºm/s</span>
                                    </div>
                                    <div class="form-group-inline">
                                        <label>Acc:</label>
                                        <input type="number" id="relative-acceleration" class="form-control form-control-xs" 
                                               min="100" max="60000" step="1" value="1000">
                                        <span class="unit">Œºm/s¬≤</span>
                                    </div>
                                    <div class="form-group-inline">
                                        <label>Dec:</label>
                                        <input type="number" id="relative-deceleration" class="form-control form-control-xs" 
                                               min="100" max="60000" step="1" value="1000">
                                        <span class="unit">Œºm/s¬≤</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" id="robot-move-relative-btn" disabled>
                                <i class="icon-move"></i>
                                Move Distance
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operations Log Panel - Compact -->
            <div class="control-panel log-panel compact">
                <div class="panel-header compact">
                    <h3>Operations Log</h3>
                    <div class="log-controls">
                        <button class="btn btn-xs btn-outline" id="robot-clear-log-btn">
                            <i class="icon-clear"></i>
                            Clear
                        </button>
                        <button class="btn btn-xs btn-outline" id="robot-export-log-btn">
                            <i class="icon-export"></i>
                            Export
                        </button>
                    </div>
                </div>
                
                <div class="panel-content compact">
                    <div class="log-viewer compact" id="robot-log-viewer">
                        <div class="log-entry">
                            <span class="timestamp">[--:--:--]</span>
                            <span class="level info">INFO</span>
                            <span class="message">Robot Control Panel initialized</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Direct Embedded Robot Control JavaScript -->
<script>
(function() {
    'use strict';
    
    console.log('üöÄ [EMBEDDED] Robot Control Direct Implementation Starting...');
    
    // Disable existing robot control functionality
    window.EMBEDDED_ROBOT_CONTROL_ACTIVE = true;
    
    // Override any existing robot control functions
    window.handleConnect = function() { console.log('üö´ [EMBEDDED] Blocked existing handleConnect'); };
    window.handleDisconnect = function() { console.log('üö´ [EMBEDDED] Blocked existing handleDisconnect'); };
    window.handleServoOn = function() { console.log('üö´ [EMBEDDED] Blocked existing handleServoOn'); };
    window.handleServoOff = function() { console.log('üö´ [EMBEDDED] Blocked existing handleServoOff'); };
    window.handleHomeAxis = function() { console.log('üö´ [EMBEDDED] Blocked existing handleHomeAxis'); };
    window.handleMoveAbsolute = function() { console.log('üö´ [EMBEDDED] Blocked existing handleMoveAbsolute'); };
    window.handleMoveRelative = function() { console.log('üö´ [EMBEDDED] Blocked existing handleMoveRelative'); };
    window.handleEmergencyStop = function() { console.log('üö´ [EMBEDDED] Blocked existing handleEmergencyStop'); };
    
    // Global state variables
    let isConnected = false;
    let axisId = 0;
    let motionStatus = 'idle'; // 'idle', 'moving', 'homing', 'stopped'
    let servoEnabled = false;
    let currentPosition = 0;
    
    // Polling intervals
    let positionPollingInterval = null;
    let motionMonitoringInterval = null;
    
    // Force override existing robot control functionality
    function forceInitializeEmbeddedControl() {
        console.log('üöÄ [EMBEDDED] DOM Ready - Initializing Robot Control...');
        console.log('üîß [EMBEDDED] Removing existing event listeners...');
        
        // Remove all existing event listeners by cloning elements
        const buttonIds = [
            'robot-connect-btn', 'robot-disconnect-btn',
            'robot-servo-on-btn', 'robot-servo-off-btn',
            'robot-emergency-stop-btn', 'robot-home-axis-btn',
            'robot-move-absolute-btn', 'robot-move-relative-btn',
            'robot-refresh-status-btn'
        ];
        
        buttonIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
                console.log(`üîß [EMBEDDED] Removed existing listeners from ${id}`);
            }
        });
        
        // Get axis ID from dropdown if available
        const axisSelect = document.getElementById('robot-axis-select');
        if (axisSelect) {
            axisId = parseInt(axisSelect.value) || 0;
            const newAxisSelect = axisSelect.cloneNode(true);
            axisSelect.parentNode.replaceChild(newAxisSelect, axisSelect);
            newAxisSelect.addEventListener('change', function() {
                axisId = parseInt(this.value) || 0;
                console.log('üîß [EMBEDDED] Axis changed to:', axisId);
            });
        }
        
        initializeEventListeners();
        initializePositionPolling();
        
        // Override global functions with embedded versions
        window.handleConnect = handleConnect;
        window.handleDisconnect = handleDisconnect;
        window.handleServoOn = handleServoOn;
        window.handleServoOff = handleServoOff;
        window.handleHomeAxis = handleHomeAxis;
        window.handleMoveAbsolute = handleMoveAbsolute;
        window.handleMoveRelative = handleMoveRelative;
        window.handleEmergencyStop = handleEmergencyStop;
        window.handleRefreshStatus = handleRefreshStatus;
        
        window.EMBEDDED_ROBOT_INITIALIZED = true;
        
        console.log('‚úÖ [EMBEDDED] Robot Control Initialized Successfully');
        console.log('‚úÖ [EMBEDDED] Global functions overridden with embedded versions');
    }

    // Initialize when DOM is ready, with delay to override existing code
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit to let existing code load first, then override
        setTimeout(forceInitializeEmbeddedControl, 500);
    });
    
    // Also try immediate initialization if DOM is already ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceInitializeEmbeddedControl);
    } else {
        setTimeout(forceInitializeEmbeddedControl, 100);
    }
    
    // Initialize event listeners
    function initializeEventListeners() {
        console.log('üîß [EMBEDDED] Setting up event listeners...');
        
        // Connect/Disconnect
        const connectBtn = document.getElementById('robot-connect-btn');
        const disconnectBtn = document.getElementById('robot-disconnect-btn');
        
        if (connectBtn) {
            connectBtn.addEventListener('click', handleConnect);
        }
        if (disconnectBtn) {
            disconnectBtn.addEventListener('click', handleDisconnect);
        }
        
        // Servo controls
        const servoOnBtn = document.getElementById('robot-servo-on-btn');
        const servoOffBtn = document.getElementById('robot-servo-off-btn');
        
        if (servoOnBtn) {
            servoOnBtn.addEventListener('click', handleServoOn);
        }
        if (servoOffBtn) {
            servoOffBtn.addEventListener('click', handleServoOff);
        }
        
        // Movement controls
        const homeBtn = document.getElementById('robot-home-axis-btn');
        const moveAbsBtn = document.getElementById('robot-move-absolute-btn');
        const moveRelBtn = document.getElementById('robot-move-relative-btn');
        const emergencyBtn = document.getElementById('robot-emergency-stop-btn');
        
        if (homeBtn) {
            homeBtn.addEventListener('click', handleHomeAxis);
        }
        if (moveAbsBtn) {
            moveAbsBtn.addEventListener('click', handleMoveAbsolute);
        }
        if (moveRelBtn) {
            moveRelBtn.addEventListener('click', handleMoveRelative);
        }
        if (emergencyBtn) {
            emergencyBtn.addEventListener('click', handleEmergencyStop);
        }
        
        // Status refresh
        const refreshBtn = document.getElementById('robot-refresh-status-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', handleRefreshStatus);
        }
        
        console.log('‚úÖ [EMBEDDED] Event listeners initialized');
    }
    
    // Position polling system
    function initializePositionPolling() {
        console.log('üöÄ [EMBEDDED] Initializing position polling...');
        startPositionPolling(1000); // Start with 1 second interval
        
        // Test that polling is working
        setTimeout(() => {
            console.log('üß™ [EMBEDDED] Testing position polling after 3 seconds...');
            console.log('üß™ [EMBEDDED] Connected:', isConnected);
            console.log('üß™ [EMBEDDED] Motion Status:', motionStatus);
            console.log('üß™ [EMBEDDED] Current Position:', currentPosition);
        }, 3000);
    }
    
    function startPositionPolling(interval) {
        console.log(`üìç [EMBEDDED] Starting position polling with ${interval}ms interval`);
        
        // Clear existing interval
        if (positionPollingInterval) {
            clearInterval(positionPollingInterval);
        }
        
        // Start new polling
        positionPollingInterval = setInterval(async () => {
            if (isConnected) {
                console.log(`üîÑ [EMBEDDED] Polling position (${interval}ms interval)...`);
                try {
                    await updatePosition();
                    console.log('‚úÖ [EMBEDDED] Position updated successfully');
                } catch (error) {
                    console.error('‚ùå [EMBEDDED] Position update failed:', error);
                }
            } else {
                console.log('‚è∏Ô∏è [EMBEDDED] Skipping position update - not connected');
            }
        }, interval);
        
        console.log(`üìç [EMBEDDED] Position polling started with ${interval}ms interval`);
    }
    
    function updatePollingInterval() {
        if (motionStatus === 'moving' || motionStatus === 'homing') {
            console.log('üèÉ [EMBEDDED] Motion detected: Switching to fast polling (100ms)');
            startPositionPolling(100); // 0.1 second
        } else {
            console.log('üõë [EMBEDDED] Motion completed: Switching to normal polling (1000ms)');
            startPositionPolling(1000); // 1 second
        }
    }
    
    // API functions
    async function apiCall(method, url, data = null) {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            }
        };
        
        if (data) {
            options.body = JSON.stringify(data);
        }
        
        console.log(`üì° [EMBEDDED] API ${method} ${url}`, data || '');
        
        try {
            const response = await fetch(`/api${url}`, options);
            const result = await response.json();
            
            console.log(`‚úÖ [EMBEDDED] API Response:`, result);
            return result;
        } catch (error) {
            console.error(`‚ùå [EMBEDDED] API Error:`, error);
            throw error;
        }
    }
    
    async function updatePosition() {
        try {
            const result = await apiCall('GET', `/hardware/robot/position?axis_id=${axisId}`);
            if (result.success) {
                currentPosition = result.data.position;
                updatePositionDisplay(currentPosition);
                console.log(`üìç [EMBEDDED] Position updated: ${currentPosition}Œºm`);
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Failed to update position:', error);
        }
    }
    
    async function updateStatus() {
        try {
            const result = await apiCall('GET', `/hardware/robot/status?axis_id=${axisId}`);
            if (result.success) {
                const status = result.data;
                
                isConnected = status.connected;
                servoEnabled = status.servo_enabled;
                currentPosition = status.current_position || status.position || 0;
                
                // Check if motion status changed
                const wasMoving = (motionStatus === 'moving' || motionStatus === 'homing');
                const isMoving = status.is_moving;
                
                if (wasMoving && !isMoving) {
                    console.log('‚úÖ [EMBEDDED] Motion completed detected!');
                    motionStatus = 'idle';
                    updatePollingInterval();
                    stopMotionMonitoring();
                }
                
                updateStatusDisplay(status);
                console.log('üìä [EMBEDDED] Status updated:', status);
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Failed to update status:', error);
        }
    }
    
    // Motion monitoring
    function startMotionMonitoring() {
        console.log('üëÄ [EMBEDDED] Starting motion monitoring...');
        
        if (motionMonitoringInterval) {
            clearInterval(motionMonitoringInterval);
        }
        
        motionMonitoringInterval = setInterval(async () => {
            try {
                const result = await apiCall('GET', `/hardware/robot/status?axis_id=${axisId}`);
                if (result.success) {
                    const isMoving = result.data.is_moving;
                    console.log(`üîç [EMBEDDED] Motion check: isMoving=${isMoving}, motionStatus=${motionStatus}`);
                    
                    if (!isMoving && (motionStatus === 'moving' || motionStatus === 'homing')) {
                        console.log('‚úÖ [EMBEDDED] Motion completed detected!');
                        motionStatus = 'idle';
                        updatePollingInterval();
                        stopMotionMonitoring();
                        await updateStatus();
                    } else if (motionStatus === 'stopped') {
                        console.log('üõë [EMBEDDED] Emergency stop detected, stopping monitoring');
                        stopMotionMonitoring();
                        updatePollingInterval();
                    }
                }
            } catch (error) {
                console.warn('‚ùå [EMBEDDED] Motion monitoring failed:', error);
            }
        }, 100); // Check every 100ms
        
        console.log('‚úÖ [EMBEDDED] Motion monitoring started');
    }
    
    function stopMotionMonitoring() {
        if (motionMonitoringInterval) {
            clearInterval(motionMonitoringInterval);
            motionMonitoringInterval = null;
            console.log('üõë [EMBEDDED] Motion monitoring stopped');
        }
    }
    
    // Event handlers - Override global functions
    async function handleConnect() {
        console.log('üîå [EMBEDDED] Connect clicked');
        try {
            const result = await apiCall('POST', '/hardware/robot/connect', { axis_id: axisId, irq_no: 7 });
            if (result.success) {
                isConnected = true;
                await updateStatus();
                showMessage('Connected successfully', 'success');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Connect failed:', error);
            showMessage('Connect failed', 'error');
        }
    }
    
    async function handleDisconnect() {
        console.log('üîå [EMBEDDED] Disconnect clicked');
        try {
            const result = await apiCall('POST', '/hardware/robot/disconnect');
            if (result.success) {
                isConnected = false;
                motionStatus = 'idle';
                updatePollingInterval();
                stopMotionMonitoring();
                showMessage('Disconnected successfully', 'info');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Disconnect failed:', error);
        }
    }
    
    async function handleServoOn() {
        console.log('‚ö° [EMBEDDED] Servo enable clicked');
        try {
            const result = await apiCall('POST', '/hardware/robot/servo/enable', { axis_id: axisId });
            if (result.success) {
                servoEnabled = true;
                await updateStatus();
                showMessage('Servo enabled', 'success');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Servo enable failed:', error);
            showMessage('Servo enable failed', 'error');
        }
    }
    
    async function handleServoOff() {
        console.log('üî¥ [EMBEDDED] Servo disable clicked');
        try {
            const result = await apiCall('POST', '/hardware/robot/servo/disable', { axis_id: axisId });
            if (result.success) {
                servoEnabled = false;
                await updateStatus();
                showMessage('Servo disabled', 'info');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Servo disable failed:', error);
        }
    }
    
    async function handleHomeAxis() {
        console.log('üè† [EMBEDDED] Home axis clicked');
        try {
            motionStatus = 'homing';
            updatePollingInterval();
            startMotionMonitoring();
            
            const result = await apiCall('POST', '/hardware/robot/home-axis', { axis_id: axisId });
            if (result.success) {
                showMessage('Homing started', 'info');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Home failed:', error);
            motionStatus = 'idle';
            updatePollingInterval();
            stopMotionMonitoring();
            showMessage('Home failed', 'error');
        }
    }
    
    async function handleMoveAbsolute() {
        console.log('üéØ [EMBEDDED] Absolute move clicked');
        try {
            const position = parseFloat(document.getElementById('absolute-position').value);
            const velocity = parseFloat(document.getElementById('absolute-velocity').value) || 200;
            const acceleration = parseFloat(document.getElementById('absolute-acceleration').value) || 1000;
            const deceleration = parseFloat(document.getElementById('absolute-deceleration').value) || 1000;
            
            if (isNaN(position)) {
                showMessage('Invalid position value', 'error');
                return;
            }
            
            motionStatus = 'moving';
            updatePollingInterval();
            startMotionMonitoring();
            
            const result = await apiCall('POST', '/hardware/robot/move-absolute', {
                axis_id: axisId,
                position: position,
                velocity: velocity,
                acceleration: acceleration,
                deceleration: deceleration
            });
            
            if (result.success) {
                showMessage(`Moving to ${position}Œºm`, 'info');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Absolute move failed:', error);
            motionStatus = 'idle';
            updatePollingInterval();
            stopMotionMonitoring();
            showMessage('Absolute move failed', 'error');
        }
    }
    
    async function handleMoveRelative() {
        console.log('‚ÜîÔ∏è [EMBEDDED] Relative move clicked');
        try {
            const distance = parseFloat(document.getElementById('relative-distance').value);
            const velocity = parseFloat(document.getElementById('relative-velocity').value) || 200;
            const acceleration = parseFloat(document.getElementById('relative-acceleration').value) || 1000;
            const deceleration = parseFloat(document.getElementById('relative-deceleration').value) || 1000;
            
            if (isNaN(distance)) {
                showMessage('Invalid distance value', 'error');
                return;
            }
            
            motionStatus = 'moving';
            updatePollingInterval();
            startMotionMonitoring();
            
            const result = await apiCall('POST', '/hardware/robot/move-relative', {
                axis_id: axisId,
                distance: distance,
                velocity: velocity,
                acceleration: acceleration,
                deceleration: deceleration
            });
            
            if (result.success) {
                showMessage(`Moving ${distance}Œºm`, 'info');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Relative move failed:', error);
            motionStatus = 'idle';
            updatePollingInterval();
            stopMotionMonitoring();
            showMessage('Relative move failed', 'error');
        }
    }
    
    async function handleEmergencyStop() {
        console.log('üõë [EMBEDDED] Emergency stop clicked!');
        try {
            const result = await apiCall('POST', '/hardware/robot/emergency-stop', { axis_id: axisId });
            if (result.success) {
                motionStatus = 'stopped';
                updatePollingInterval();
                stopMotionMonitoring();
                
                // Immediately refresh status to update servo state
                await updateStatus();
                
                showMessage('Emergency stop executed', 'warning');
                console.log('üõë [EMBEDDED] Emergency stop completed successfully');
            }
        } catch (error) {
            console.error('‚ùå [EMBEDDED] Emergency stop failed:', error);
            showMessage('Emergency stop failed', 'error');
        }
    }
    
    async function handleRefreshStatus() {
        console.log('üîÑ [EMBEDDED] Refresh status clicked');
        await updateStatus();
        showMessage('Status refreshed', 'info');
    }
    
    // UI update functions
    function updatePositionDisplay(position) {
        const positionElement = document.getElementById('robot-current-position');
        if (positionElement) {
            positionElement.textContent = position.toFixed(3);
        }
    }
    
    function updateStatusDisplay(status) {
        // Update servo status
        const servoElement = document.getElementById('robot-servo-status');
        if (servoElement) {
            servoElement.textContent = status.servo_enabled ? 'Enabled' : 'Disabled';
            servoElement.className = status.servo_enabled ? 'status-success' : 'status-error';
        }
        
        // Update motion status
        const motionElement = document.getElementById('robot-motion-status');
        if (motionElement) {
            const statusText = status.is_moving ? 'Moving' : 'Idle';
            motionElement.textContent = statusText;
            motionElement.className = status.is_moving ? 'status-warning' : 'status-success';
        }
        
        // Update position
        updatePositionDisplay(status.current_position || status.position || 0);
    }
    
    function showMessage(message, type = 'info') {
        console.log(`üí¨ [EMBEDDED] ${type.toUpperCase()}: ${message}`);
        
        // Try to find notification area
        const logViewer = document.getElementById('robot-log-viewer');
        if (logViewer) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="level ${type}">${type.toUpperCase()}</span>
                <span class="message">${message}</span>
            `;
            logViewer.insertBefore(logEntry, logViewer.firstChild);
            
            // Keep only last 50 entries
            while (logViewer.children.length > 50) {
                logViewer.removeChild(logViewer.lastChild);
            }
        }
    }
    
    // Global error handler
    window.addEventListener('error', function(event) {
        console.error('üö® [EMBEDDED] Global error:', event.error);
    });
    
    window.addEventListener('unhandledrejection', function(event) {
        console.error('üö® [EMBEDDED] Unhandled promise rejection:', event.reason);
    });
    
    console.log('‚úÖ [EMBEDDED] Robot Control Script Loaded Successfully');
})();
</script>